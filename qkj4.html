<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawflow + BlockSuite æ‹–æ‹½åè°ƒç‰ˆ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@0.0.59/dist/drawflow.min.js"></script>
    <script src="bseditor.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .toolbar {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .toolbar button:hover {
            background: #5a6fd8;
        }

        #drawflow {
            width: 100%;
            height: calc(100vh - 120px);
            background: #f5f7fa;
            background-image: 
                radial-gradient(circle, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* èŠ‚ç‚¹æ ·å¼ - æ‹–æ‹½åè°ƒæ”¯æŒ */
        .drawflow .node {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            min-height: 100px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .drawflow .node:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .drawflow .node.selected {
            border-color: #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        /* æ ‡é¢˜æ  - å”¯ä¸€å¯ç§»åŠ¨åŒºåŸŸ */
        .drawflow .node .title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            cursor: move;
            user-select: none;
            position: relative;
            z-index: 10;
        }

        /* å†…å®¹åŒºåŸŸ - æ™ºèƒ½äº‹ä»¶å¤„ç† */
        .drawflow .node .content {
            padding: 0;
            overflow-y: auto;
            cursor: default;
            user-select: text;
        }

        /* BlockSuiteç¼–è¾‘å™¨å®¹å™¨ç‰¹æ®Šæ ·å¼ */
        .blocksuite-editor-container {
            position: relative;
            z-index: 1;
        }

        /* é˜²æ­¢BlockSuiteå†…éƒ¨æ‹–æ‹½å½±å“èŠ‚ç‚¹ç§»åŠ¨ */
        .blocksuite-editor-container .block {
            cursor: default;
        }

        .blocksuite-editor-container .block-handle {
            cursor: grab !important;
        }

        .blocksuite-editor-container .block-handle:active {
            cursor: grabbing !important;
        }

        /* å¤§å°è°ƒèŠ‚æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: se-resize;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .drawflow .node:hover .resize-handle,
        .drawflow .node.selected .resize-handle {
            opacity: 1;
        }

        .resize-handle:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .node-resizing {
            border-color: #667eea !important;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4) !important;
        }

        /* äº‹ä»¶æ‹¦æˆªå±‚ */
        .event-interceptor {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .event-interceptor.active {
            pointer-events: all;
        }

        /* å¸®åŠ©æç¤º */
        .help-tooltip {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 250px;
        }

        .help-tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>Drawflow + BlockSuite æ‹–æ‹½åè°ƒç‰ˆ</h1>
        <p>èŠ‚ç‚¹æ ‡é¢˜æ å¯ç§»åŠ¨ï¼ŒBlockSuiteå†…éƒ¨å—å¯æ‹–æ‹½é‡æ’</p>
    </div>

    <div class="toolbar">
        <button onclick="addNote()">ğŸ“ æ·»åŠ ç¬”è®°</button>
        <button onclick="addTodo()">âœ… æ·»åŠ å¾…åŠ</button>
        <button onclick="addTable()">ğŸ“Š æ·»åŠ è¡¨æ ¼</button>
        <button onclick="addBlocksuite()">ğŸ“‹ BlockSuiteç¼–è¾‘å™¨</button>
        <button onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
        <button onclick="loadData()">ğŸ“ åŠ è½½</button>
        <button onclick="toggleHelp()">â“ å¸®åŠ©</button>
    </div>

    <div id="drawflow"></div>

    <!-- èŠ‚ç‚¹æ¨¡æ¿ -->
    <template id="note-template">
        <div>
            <div class="title">ğŸ“ ç¬”è®°</div>
            <div class="content content-no-move">
                <textarea placeholder="åŒå‡»ç¼–è¾‘ç¬”è®°å†…å®¹..." 
                          style="width: 100%; min-height: 100px; border: none; padding: 15px; resize: none; outline: none;"></textarea>
            </div>
            <div class="resize-handle"></div>
        </div>
    </template>

    <template id="todo-template">
        <div>
            <div class="title">âœ… å¾…åŠæ¸…å•</div>
            <div class="content content-no-move">
                <div class="todo-container" style="padding: 15px;">
                    <div class="todo-list"></div>
                    <button onclick="addTodoItem(this)" style="margin-top: 10px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">+ æ·»åŠ å¾…åŠ</button>
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>
    </template>

    <template id="table-template">
        <div>
            <div class="title">ğŸ“Š è¡¨æ ¼</div>
            <div class="content content-no-move">
                <div class="table-container" style="padding: 15px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tbody></tbody>
                    </table>
                    <div style="margin-top: 10px;">
                        <button onclick="addTableRow(this)" style="margin-right: 10px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">+ è¡Œ</button>
                        <button onclick="addTableColumn(this)" style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">+ åˆ—</button>
                    </div>
                </div>
            </div>
            <div class="resize-handle"></div>
        </div>
    </template>

    <!-- <template id="blocksuite-template">
        <div>
            <div class="title">ğŸ“‹ BlockSuiteç¼–è¾‘å™¨</div>
            <div class="content content-no-move blocksuite-editor-container">
                <div class="blocksuite-editor-wrapper"></div>
            </div>
            <div class="resize-handle"></div>
        </div>
    </template> -->
<!-- 
     <div class="title" contenteditable="true">ğŸ“‹ BlockSuiteç¼–è¾‘å™¨</div> -->
    <template id="blocksuite-template">
    <div>
       
        <div class="content content-no-move blocksuite-editor-container">
            <div class="blocksuite-editor-wrapper">
                <div class="blocksuite-editor">
                    <div class="editor-container">
                        <div class="editor-header">
                            <div class="editor-title" contenteditable="true">æ— æ ‡é¢˜æ–‡æ¡£</div>
                            <div class="editor-toolbar">
                                <button class="toolbar-btn" data-action="heading">æ ‡é¢˜</button>
                                <button class="toolbar-btn" data-action="list">åˆ—è¡¨</button>
                                <button class="toolbar-btn" data-action="quote">å¼•ç”¨</button>
                                <button class="toolbar-btn" data-action="code">ä»£ç </button>
                                <button class="toolbar-btn" data-action="table">è¡¨æ ¼</button>
                                <button class="toolbar-btn" data-action="kanban">çœ‹æ¿</button>
                                <button class="toolbar-btn" data-action="divider">åˆ†å‰²çº¿</button>
                                <button class="toolbar-btn" data-action="undo">æ’¤é”€</button>
                                <button class="toolbar-btn" data-action="redo">é‡åš</button>
                                <button class="toolbar-btn" data-action="export">å¯¼å‡º</button>
                            </div>
                        </div>
                        <div class="editor-content"></div>
                        <div class="editor-stats">
                            <span>å—æ•°: <span class="block-count">0</span></span>
                            <span>å­—æ•°: <span class="word-count">0</span></span>
                            <span>å­—ç¬¦: <span class="char-count">0</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
</template>

    <!-- å¸®åŠ©æç¤º -->
    <div class="help-tooltip" id="help-tooltip">
        <strong>ä½¿ç”¨æç¤ºï¼š</strong><br>
        â€¢ èŠ‚ç‚¹æ ‡é¢˜æ å¯æ‹–æ‹½ç§»åŠ¨æ•´ä¸ªèŠ‚ç‚¹<br>
        â€¢ BlockSuiteç¼–è¾‘å™¨å†…å—å¯é€šè¿‡å·¦ä¾§æ‰‹æŸ„æ‹–æ‹½é‡æ’<br>
        â€¢ åŒå‡»èŠ‚ç‚¹æ ‡é¢˜å¯è‡ªåŠ¨è°ƒæ•´å¤§å°<br>
        â€¢ å³ä¸‹è§’åœ†ç‚¹å¯æ‰‹åŠ¨è°ƒèŠ‚èŠ‚ç‚¹å¤§å°
    </div>

    <script>
        // åˆå§‹åŒ–Drawflow
        const editor = new Drawflow(document.getElementById("drawflow"));
        editor.reroute = true;
        editor.reroute_fix_curvature = true;
        editor.force_first_input = false;
        editor.draggable_inputs = false;

        // é‡å†™äº‹ä»¶å¤„ç†ç³»ç»Ÿ - åè°ƒBlockSuiteå’ŒDrawflow
        const originalStart = editor.start.bind(editor);
        editor.start = function() {
            originalStart();
            setupDragCoordination();
        };

        // è®¾ç½®æ‹–æ‹½åè°ƒæœºåˆ¶
        function setupDragCoordination() {
            const canvas = document.getElementById('drawflow');
            
            // äº‹ä»¶æ‹¦æˆªå™¨ - æ™ºèƒ½è¯†åˆ«äº‹ä»¶æ¥æº
            let isBlockDragging = false;
            let blockDragElement = null;

            // ç›‘å¬BlockSuiteå†…éƒ¨æ‹–æ‹½å¼€å§‹
            canvas.addEventListener('dragstart', function(e) {
                const blockHandle = e.target.closest('.block-handle');
                if (blockHandle) {
                    isBlockDragging = true;
                    blockDragElement = e.target.closest('.block');
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°Drawflow
                }
            }, true);

            // ç›‘å¬BlockSuiteå†…éƒ¨æ‹–æ‹½ç»“æŸ
            canvas.addEventListener('dragend', function(e) {
                if (isBlockDragging) {
                    isBlockDragging = false;
                    blockDragElement = null;
                    e.stopPropagation();
                }
            }, true);

            // é‡å†™Drawflowçš„èŠ‚ç‚¹é€‰æ‹©é€»è¾‘
            const originalNodeSelected = editor.nodeSelected;
            editor.nodeSelected = function(e) {
                const target = e.target;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨BlockSuiteç¼–è¾‘å™¨å†…
                const blocksuiteContainer = target.closest('.blocksuite-editor-container');
                if (blocksuiteContainer) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å—çº§æ‹–æ‹½æ‰‹æŸ„
                    const blockHandle = target.closest('.block-handle');
                    if (blockHandle) {
                        // å…è®¸BlockSuiteå†…éƒ¨æ‹–æ‹½ï¼Œä¸é€‰ä¸­èŠ‚ç‚¹
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å†…å®¹åŒºåŸŸ
                    const contentArea = target.closest('.content-no-move');
                    if (contentArea && !target.closest('.title')) {
                        // å†…å®¹åŒºåŸŸç‚¹å‡»ï¼Œä¸é€‰ä¸­èŠ‚ç‚¹
                        return;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æ ‡é¢˜æ åŒºåŸŸ
                const titleElement = target.closest('.title');
                if (titleElement) {
                    // æ ‡é¢˜æ ç‚¹å‡»ï¼Œæ­£å¸¸é€‰ä¸­èŠ‚ç‚¹
                    originalNodeSelected.call(this, e);
                }
            };

            // é‡å†™Drawflowçš„æ‹–æ‹½å¼€å§‹é€»è¾‘
            const originalDragNode = editor.dragNode;
            editor.dragNode = function(e) {
                const target = e.target;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨BlockSuiteç¼–è¾‘å™¨å†…
                const blocksuiteContainer = target.closest('.blocksuite-editor-container');
                if (blocksuiteContainer) {
                    // åœ¨BlockSuiteå†…ï¼Œç¦æ­¢èŠ‚ç‚¹ç§»åŠ¨
                    this.ele_selected = null;
                    this.drag = false;
                    this.editor_selected = false;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨æ ‡é¢˜æ åŒºåŸŸ
                const titleElement = target.closest('.title');
                if (!titleElement) {
                    // ä¸åœ¨æ ‡é¢˜æ ï¼Œç¦æ­¢ç§»åŠ¨
                    this.ele_selected = null;
                    this.drag = false;
                    this.editor_selected = false;
                    return;
                }
                
                // åœ¨æ ‡é¢˜æ åŒºåŸŸï¼Œå…è®¸èŠ‚ç‚¹ç§»åŠ¨
                originalDragNode.call(this, e);
            };

            // é˜»æ­¢BlockSuiteå†…éƒ¨äº‹ä»¶å†’æ³¡
            canvas.addEventListener('mousedown', function(e) {
                const blocksuiteContainer = e.target.closest('.blocksuite-editor-container');
                if (blocksuiteContainer) {
                    const blockHandle = e.target.closest('.block-handle');
                    if (blockHandle) {
                        // å—çº§æ‹–æ‹½æ‰‹æŸ„ï¼Œé˜»æ­¢å†’æ³¡
                        e.stopPropagation();
                    } else if (!e.target.closest('.title')) {
                        // å†…å®¹åŒºåŸŸï¼Œé˜»æ­¢å†’æ³¡
                        e.stopPropagation();
                    }
                }
            }, true);

            // é˜»æ­¢é¼ æ ‡ç§»åŠ¨äº‹ä»¶åœ¨BlockSuiteå†…è§¦å‘èŠ‚ç‚¹ç§»åŠ¨
            canvas.addEventListener('mousemove', function(e) {
                const blocksuiteContainer = e.target.closest('.blocksuite-editor-container');
                if (blocksuiteContainer && editor.drag) {
                    // å¦‚æœæ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹ä½†é¼ æ ‡åœ¨BlockSuiteå†…ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨æ ‡é¢˜æ 
                    const titleElement = e.target.closest('.title');
                    if (!titleElement) {
                        // ä¸åœ¨æ ‡é¢˜æ ï¼Œå¼ºåˆ¶åœæ­¢æ‹–æ‹½
                        editor.drag = false;
                        editor.ele_selected = null;
                    }
                }
            });
        }

        // æ³¨å†ŒèŠ‚ç‚¹ç±»å‹
        function registerNodeTypes() {
            const noteTemplate = document.getElementById('note-template').content.cloneNode(true);
            const todoTemplate = document.getElementById('todo-template').content.cloneNode(true);
            const tableTemplate = document.getElementById('table-template').content.cloneNode(true);
            const blocksuiteTemplate = document.getElementById('blocksuite-template').content.cloneNode(true);

            editor.registerNode('note', noteTemplate);
            editor.registerNode('todo', todoTemplate);
            editor.registerNode('table', tableTemplate);
            editor.registerNode('blocksuite', blocksuiteTemplate);
        }

        // èŠ‚ç‚¹åˆ›å»ºäº‹ä»¶å¤„ç†
        editor.on('nodeCreated', function(nodeId) {
            const node = editor.getNodeFromId(nodeId);
            
            setTimeout(() => {
                initializeNodeSize(nodeId);
                
                switch(node.name) {
                    case 'note':
                        if (!node.data.content) {
                            editor.updateNodeDataFromId(nodeId, { content: 'åŒå‡»ç¼–è¾‘ç¬”è®°å†…å®¹...' });
                        }
                        autoResizeTextarea(nodeId);
                        break;
                    case 'todo':
                        if (!node.data.items) {
                            editor.updateNodeDataFromId(nodeId, { items: [{text: 'ç¤ºä¾‹å¾…åŠ', completed: false}] });
                        }
                        renderTodoNode(nodeId, node.data.items || []);
                        autoResizeNode(nodeId);
                        break;
                    case 'table':
                        if (!node.data.data) {
                            editor.updateNodeDataFromId(nodeId, { data: [['åˆ—1', 'åˆ—2'], ['æ•°æ®1', 'æ•°æ®2']] });
                        }
                        renderTableNode(nodeId, node.data.data || [['']]);
                        autoResizeNode(nodeId);
                        break;
                    case 'blocksuite':
                        initializeBlocksuiteNode(nodeId);
                        break;
                }
            }, 100);
        });

        // åˆå§‹åŒ–èŠ‚ç‚¹å¤§å°
        function initializeNodeSize(nodeId) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const node = editor.getNodeFromId(nodeId);
            
            if (node.data.width && node.data.height) {
                nodeElement.style.width = node.data.width + 'px';
                nodeElement.style.height = node.data.height + 'px';
            }

            // åŒå‡»æ ‡é¢˜è‡ªåŠ¨è°ƒæ•´å¤§å°
            const title = nodeElement.querySelector('.title');
            if (title) {
                title.addEventListener('dblclick', () => {
                    autoFitNode(nodeId);
                });
            }

            // åˆå§‹åŒ–å¤§å°è°ƒèŠ‚
            const resizeHandle = nodeElement.querySelector('.resize-handle');
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', (e) => startResize(e, nodeId));
            }
        }

        // å¼€å§‹è°ƒæ•´å¤§å°
        function startResize(e, nodeId) {
            e.preventDefault();
            e.stopPropagation();
            
            let isResizing = true;
            const currentNode = document.querySelector(`#node-${nodeId}`);
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = parseInt(document.defaultView.getComputedStyle(currentNode).width, 10);
            const startHeight = parseInt(document.defaultView.getComputedStyle(currentNode).height, 10);
            const minWidth = 300;
            const minHeight = 100;
            
            currentNode.classList.add('node-resizing');
            
            function doResize(e) {
                if (!isResizing) return;
                
                const newWidth = Math.max(minWidth, startWidth + (e.clientX - startX));
                const newHeight = Math.max(minHeight, startHeight + (e.clientY - startY));
                
                currentNode.style.width = newWidth + 'px';
                currentNode.style.height = newHeight + 'px';
                
                // æ›´æ–°èŠ‚ç‚¹æ•°æ®
                editor.updateNodeDataFromId(nodeId, {
                    width: newWidth,
                    height: newHeight
                });
            }
            
            function stopResize() {
                if (!isResizing) return;
                
                isResizing = false;
                currentNode.classList.remove('node-resizing');
                
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
            }
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }

        // åˆå§‹åŒ–BlockSuiteèŠ‚ç‚¹
        function initializeBlocksuiteNode(nodeId) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const wrapper = nodeElement.querySelector('.blocksuite-editor-wrapper');
            const node = editor.getNodeFromId(nodeId);
            
            const blocksuiteEditor = createBlocksuiteEditor(wrapper,{
                container: wrapper,
                title: '',  //BlockSuiteæ–‡æ¡£
                toolbar:false,
                onChange: (content) => {
                    editor.updateNodeDataFromId(nodeId, { blocksuiteContent: content });
                }
            });
            
            if (node.data.blocksuiteContent) {
                blocksuiteEditor.loadContent(node.data.blocksuiteContent);
            }
            
            if (node && node.data.blocksuiteContent) {
                blocksuiteEditor.loadContent(node.data.blocksuiteContent);
            } else {
                blocksuiteEditor.createBlock('heading', { level: 3, content: 'æ¬¢è¿ä½¿ç”¨BlockSuite' });
                blocksuiteEditor.createBlock('paragraph', 'è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„å—çº§ç¼–è¾‘å™¨ï¼Œæ”¯æŒå¤šç§å†…å®¹ç±»å‹ã€‚');
            }

            // ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶
            const toolbar = nodeElement.querySelector('.editor-toolbar');
            if (toolbar) {
                toolbar.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toolbar-btn')) {
                        const action = e.target.dataset.action;
                        switch(action) {
                            case 'heading':
                                blocksuiteEditor.createBlock('heading');
                                break;
                            case 'list':
                                blocksuiteEditor.createBlock('list');
                                break;
                            case 'quote':
                                blocksuiteEditor.createBlock('quote');
                                break;
                            case 'code':
                                blocksuiteEditor.createBlock('code');
                                break;
                            case 'table':
                                blocksuiteEditor.createBlock('table');
                                break;
                            case 'kanban':
                                blocksuiteEditor.createBlock('kanban');
                                break;
                            case 'divider':
                                blocksuiteEditor.createBlock('divider');
                                break;
                            case 'undo':
                                blocksuiteEditor.undo();
                                break;
                            case 'redo':
                                blocksuiteEditor.redo();
                                break;
                            case 'export':
                                blocksuiteEditor.export();
                                break;
                        }
                    }
                });
            }
            // ä¿å­˜ç¼–è¾‘å™¨å®ä¾‹
            nodeElement._blocksuiteEditor = blocksuiteEditor;
            
            // è‡ªåŠ¨è°ƒæ•´å¤§å°
            autoResizeNode(nodeId);
        }

        // å…¶ä»–è¾…åŠ©å‡½æ•°
        function autoResizeTextarea(nodeId) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const textarea = nodeElement.querySelector('textarea');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.max(100, this.scrollHeight) + 'px';
                    
                    const node = editor.getNodeFromId(nodeId);
                    editor.updateNodeDataFromId(nodeId, { 
                        content: this.value,
                        height: Math.max(150, nodeElement.offsetHeight)
                    });
                });
                
                textarea.value = editor.getNodeFromId(nodeId).data.content || '';
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(100, textarea.scrollHeight) + 'px';
            }
        }

        function renderTodoNode(nodeId, items) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const todoList = nodeElement.querySelector('.todo-list');
            if (!todoList) return;
            
            todoList.innerHTML = '';
            items.forEach((item, index) => {
                const todoItem = document.createElement('div');
                todoItem.style.cssText = 'display: flex; align-items: center; margin: 5px 0;';
                todoItem.innerHTML = `
                    <input type="checkbox" ${item.completed ? 'checked' : ''} 
                           onchange="updateTodoItem(${nodeId}, ${index}, this.checked)"
                           style="margin-right: 10px;">
                    <input type="text" value="${item.text}" 
                           onchange="updateTodoText(${nodeId}, ${index}, this.value)"
                           style="flex: 1; border: none; border-bottom: 1px solid #eee; padding: 5px;">
                    <button onclick="removeTodoItem(${nodeId}, ${index})" 
                            style="margin-left: 10px; background: #ff4757; color: white; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer;">Ã—</button>
                `;
                todoList.appendChild(todoItem);
            });
        }

        function renderTableNode(nodeId, data) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const table = nodeElement.querySelector('table tbody');
            if (!table) return;
            
            table.innerHTML = '';
            data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((cell, colIndex) => {
                    const cellElement = rowIndex === 0 ? document.createElement('th') : document.createElement('td');
                    cellElement.innerHTML = `<input type="text" value="${cell}" 
                        onchange="updateTableCell(${nodeId}, ${rowIndex}, ${colIndex}, this.value)"
                        style="width: 100%; border: none; padding: 5px;">`;
                    tr.appendChild(cellElement);
                });
                table.appendChild(tr);
            });
        }

        function autoResizeNode(nodeId) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const content = nodeElement.querySelector('.content');
            if (content) {
                const scrollHeight = content.scrollHeight;
                const currentHeight = parseInt(nodeElement.style.height || '150');
                if (scrollHeight > currentHeight - 50) {
                    const newHeight = Math.max(150, scrollHeight + 50);
                    nodeElement.style.height = newHeight + 'px';
                    editor.updateNodeDataFromId(nodeId, { height: newHeight });
                }
            }
        }

        function autoFitNode(nodeId) {
            const nodeElement = document.querySelector(`#node-${nodeId}`);
            const content = nodeElement.querySelector('.content');
            if (content) {
                const scrollHeight = content.scrollHeight;
                const newHeight = Math.max(150, scrollHeight + 50);
                nodeElement.style.height = newHeight + 'px';
                editor.updateNodeDataFromId(nodeId, { height: newHeight });
            }
        }

        // èŠ‚ç‚¹æ·»åŠ å‡½æ•°
        function addNote() {
            const nodeId = editor.addNode('note', 0, 0, 300, 150, 'note', { content: 'æ–°ç¬”è®°å†…å®¹...', width: 300, height: 150 }, 'note', true);
            //editor.selectNode(nodeId);
        }

        function addTodo() {
            const nodeId = editor.addNode('todo', 0, 0, 300, 200, 'todo', { items: [{text: 'ç¬¬ä¸€ä¸ªå¾…åŠ', completed: false}], width: 350, height: 200},'todo',true);
            //editor.selectNode(nodeId);
        }

        function addTable() {
            const nodeId = editor.addNode('table', 0, 0, 400, 200, 'table', { data: [['åˆ—1', 'åˆ—2'], ['æ•°æ®1', 'æ•°æ®2']], width: 400, height: 200},'table',true);
            //editor.selectNode(nodeId);
        }

        function addBlocksuite() {
            const nodeId = editor.addNode('blocksuite', 0, 0, 400, 300, 'blocksuite', {blocksuiteContent: null, width: 450, height: 350},"blocksuite",true);
            //editor.selectNode(nodeId);
        }

        // æ•°æ®æŒä¹…åŒ–
        function saveData() {
            const data = {
                drawflow: editor.export(),
                timestamp: Date.now()
            };
            localStorage.setItem('drawflow-bseditor-data', JSON.stringify(data));
            alert('æ•°æ®å·²ä¿å­˜ï¼');
        }

        function loadData() {
            const saved = localStorage.getItem('drawflow-bseditor-data');
            if (saved) {
                const data = JSON.parse(saved);
                editor.import(data.drawflow);
                alert('æ•°æ®å·²åŠ è½½ï¼');
            } else {
                alert('æ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼');
            }
        }

        // å¸®åŠ©æç¤º
        function toggleHelp() {
            const tooltip = document.getElementById('help-tooltip');
            tooltip.classList.toggle('show');
            setTimeout(() => tooltip.classList.remove('show'), 5000);
        }

        // åˆå§‹åŒ–
        editor.start();
        registerNodeTypes();

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        setTimeout(() => {
            if (!localStorage.getItem('drawflow-bseditor-data')) {
                addBlocksuite();
            }
        }, 500);
    </script>
</body>
</html>
